<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paediatric Emergency Dosing Calculator</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --surface-color: #1e293b;
            --primary-color: #38bdf8;
            --text-color: #e2e8f0;
            --text-muted-color: #94a3b8;
            --border-color: #334155;
            --success-color: #4ade80;
            --warning-color: #facc15;
            --danger-color: #f87171;
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            font-family: var(--font-sans);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            font-size: 16px;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
        .header h1 { font-size: 1.75rem; font-weight: 600; color: #fff; }
        .settings-btn { background: none; border: 1px solid var(--border-color); color: var(--text-muted-color); padding: 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .settings-btn:hover { background-color: var(--surface-color); color: var(--primary-color); }
        .disclaimer { background-color: rgba(248, 113, 113, 0.1); border: 1px solid var(--danger-color); color: #fca5a5; padding: 16px; border-radius: 8px; margin-bottom: 24px; font-size: 0.9rem; }
        .disclaimer strong { color: #f87171; display: block; margin-bottom: 8px; }
        .search-box { width: 100%; padding: 14px 16px; font-size: 1.1rem; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); margin-bottom: 24px; transition: border-color 0.2s, box-shadow 0.2s; }
        .search-box:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2); }
        .results-list { display: grid; gap: 12px; }
        .drug-card { background-color: var(--surface-color); border: 1px solid var(--border-color); padding: 16px; border-radius: 8px; cursor: pointer; transition: border-color 0.2s, transform 0.2s; will-change: transform; }
        .drug-card:hover { border-color: var(--primary-color); transform: translateY(-3px); }
        .drug-card h3 { font-size: 1.2rem; font-weight: 600; color: #fff; margin-bottom: 4px; }
        .drug-card p { font-size: 0.9rem; color: var(--text-muted-color); }
        #calculator-view { display: none; }
        .calculator-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .back-btn { background: none; border: none; color: var(--primary-color); font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 4px; }
        .calculator-title { font-size: 1.75rem; font-weight: 700; color: #fff; }
        .patient-input-grid { display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 16px; }
        .weight-input-group { display: flex; }
        .age-input-group { display: flex; gap: 8px; }
        .input-field label { display: block; font-size: 0.9rem; color: var(--text-muted-color); margin-bottom: 6px; }
        .input-field input { width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-color); font-size: 1rem; -moz-appearance: textfield; }
        .input-field input::-webkit-outer-spin-button, .input-field input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .input-actions { display: flex; justify-content: flex-end; margin-bottom: 24px; }
        .clear-btn { background: none; border: none; color: var(--text-muted-color); font-size: 0.9rem; cursor: pointer; transition: color 0.2s; }
        .clear-btn:hover { color: var(--primary-color); }
        .dose-result-card { background-color: var(--surface-color); border: 1px solid var(--border-color); padding: 20px; border-radius: 12px; margin-bottom: 16px; }
        .dose-result-card h4 { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); color: var(--primary-color); }
        .dose-output { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .calculated-dose .label { font-size: 0.9rem; color: var(--text-muted-color); }
        .calculated-dose .value { font-size: 2rem; font-weight: 700; color: var(--success-color); }
        .calculated-dose .value.is-capped { color: var(--warning-color); }
        .copy-btn { background-color: var(--border-color); border: none; color: var(--text-color); padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        .copy-btn:hover { background-color: #475569; }
        .dose-reason { font-size: 0.85rem; color: var(--text-muted-color); font-style: italic; margin-bottom: 16px; }
        .bnfc-ref { font-size: 0.9rem; background-color: var(--bg-color); padding: 12px; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; margin-bottom: 16px; }
        .bnfc-link { display: inline-block; background-color: var(--primary-color); color: #0f172a; padding: 10px 16px; text-decoration: none; border-radius: 6px; font-weight: 600; transition: background-color 0.2s; }
        .bnfc-link:hover { background-color: #7dd3fc; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--surface-color); padding: 24px; border-radius: 12px; width: 90%; max-width: 700px; max-height: 90vh; display: flex; flex-direction: column; border: 1px solid var(--border-color); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-header h2 { font-size: 1.5rem; color: #fff;}
        .close-btn { background: none; border: none; color: var(--text-muted-color); font-size: 1.5rem; cursor: pointer; }
        .modal-body { flex-grow: 1; overflow-y: auto; }
        #json-editor { width: 100%; height: 400px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-family: 'Courier New', Courier, monospace; font-size: 0.9rem; padding: 10px; }
        .modal-footer { margin-top: 16px; display: flex; justify-content: space-between; gap: 12px; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: opacity 0.2s; }
        .modal-btn:hover { opacity: 0.9; }
        .save-btn { background-color: var(--primary-color); color: #0f172a; font-weight: 600; }
        .reset-btn { background-color: var(--danger-color); color: #fff; }
        .hidden { display: none !important; }
        .no-results { text-align: center; padding: 20px; color: var(--text-muted-color); }
        @media (min-width: 600px) { .patient-input-grid { grid-template-columns: 1fr 1.5fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div id="main-view">
            <header class="header"><h1>Paeds Dosing</h1><button class="settings-btn" id="open-settings-btn" title="Edit Dosages" aria-label="Edit Dosages"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-4.44a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.88z"></path><path d="M18 2v6h6"></path><path d="m12 18-2-2 4-4-2-2"></path><path d="m18 12-2-2-4 4-2-2"></path></svg></button></header>
            <div class="disclaimer"><strong>FOR EDUCATIONAL USE ONLY. NOT FOR CLINICAL DECISION MAKING.</strong>This tool is a reference aid and does not replace clinical judgment, local guidelines, or the latest BNFc. Always verify dosages with official sources.</div>
            <input type="text" id="search-box" class="search-box" placeholder="Search drug or condition (e.g., 'Croup')">
            <div id="results-list" class="results-list"></div>
        </div>
        <div id="calculator-view">
            <div class="calculator-header"><button class="back-btn" id="back-to-search-btn" aria-label="Back to search"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>Back</button><h2 id="calculator-title" class="calculator-title"></h2></div>
            <div class="patient-input-grid">
                <div class="input-field"><label for="weight-input">Weight (kg)</label><div class="weight-input-group"><input type="number" id="weight-input" placeholder="e.g., 15"></div></div>
                <div class="input-field"><label>Age</label><div class="age-input-group"><input type="number" id="age-years-input" placeholder="Years"><input type="number" id="age-months-input" placeholder="Months"></div></div>
            </div>
            <div class="input-actions"><button id="clear-inputs-btn" class="clear-btn">Clear Inputs</button></div>
            <div id="dose-results-container"></div>
        </div>
    </div>
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h2>Edit Dosage Data (JSON)</h2><button id="close-settings-btn" class="close-btn" aria-label="Close settings">&times;</button></div>
            <div class="modal-body"><p style="font-size: 0.9rem; color: var(--text-muted-color); margin-bottom: 10px;">Warning: Changes here are saved locally and will affect all calculations. Edit with caution.</p><textarea id="json-editor"></textarea></div>
            <div class="modal-footer"><button id="reset-data-btn" class="modal-btn reset-btn">Reset to Defaults</button><button id="save-data-btn" class="modal-btn save-btn">Save and Close</button></div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA STORE ---
        // 'a' = total age in months, 'w' = weight in kg
        // doseType: calculated, range, fixedText, ageBand, weightBand
        const defaultDrugData = [
            {
                name: "Adrenaline (Epinephrine) 1:1000",
                conditions: ["Croup", "Anaphylaxis"],
                routes: [ { name: "Nebuliser (for Croup)", bnfcLink: "https://bnfc.nice.org.uk/drugs/adrenaline-epinephrine/", guidelines: "0.5mL/kg (max 5mL) of 1:1000 adrenaline for moderate-severe croup.", doseType: 'calculated', unit: 'mL', formula: "w * 0.5", maxDose: 5, frequency: "nebulised" } ]
            },
            {
                name: "Amoxicillin",
                conditions: ["Community Acquired Pneumonia (CAP)", "Pneumonia", "Lyme Disease"],
                routes: [ { name: "Oral (PO) for CAP", bnfcLink: "https://bnfc.nice.org.uk/drugs/amoxicillin/", guidelines: "1 month–18 years: 30mg/kg (max 1g) three times daily.", minAgeMonths: 1, doseType: 'calculated', formula: "w * 30", maxDose: 1000, frequency: "three times daily" } ]
            },
            {
                name: "Buccal Midazolam",
                conditions: ["Fits", "Seizures", "Status Epilepticus"],
                routes: [ { name: "Buccal", bnfcLink: "https://bnfc.nice.org.uk/drugs/midazolam/", guidelines: "By Age Band: 6m–1y: 2.5mg | 1–5y: 5mg | 5–10y: 7.5mg | >10y: 10mg. Single STAT dose.", doseType: 'ageBand', frequency: "STAT", tiers: [ { min: 6, max: 11, dose: "2.5mg" }, { min: 12, max: 59, dose: "5mg" }, { min: 60, max: 119, dose: "7.5mg" }, { min: 120, dose: "10mg" } ] } ]
            },
            {
                name: "Cefalexin",
                conditions: ["Urinary Tract Infection (UTI)", "Pyelonephritis"],
                routes: [ { name: "Oral (PO) for Pyelonephritis", bnfcLink: "https://bnfc.nice.org.uk/drugs/cefalexin/", guidelines: "Pyelonephritis (>3 months): 12.5–25mg/kg (max 500mg) two-three times daily for 7-10 days.", minAgeMonths: 3, doseType: 'range', formula: ["w * 12.5", "w * 25"], maxDose: 500, frequency: "two-three times daily" } ]
            },
            {
                name: "Ceftriaxone",
                conditions: ["Sepsis", "Meningitis", "Petechial Rash", "Pneumonia"],
                routes: [
                    { name: "IV / IM - Sepsis of unknown origin", bnfcLink: "https://bnfc.nice.org.uk/drugs/ceftriaxone/", guidelines: "Sepsis of unknown origin (>1 month): 80mg/kg (max 4g) once daily.", minAgeMonths: 1, doseType: 'calculated', formula: "w * 80", maxDose: 4000, frequency: "once daily" },
                    { name: "IV / IM - Confirmed Meningitis", bnfcLink: "https://bnfc.nice.org.uk/drugs/ceftriaxone/", guidelines: "Confirmed Meningitis: 100mg/kg (max 4g) once daily.", minAgeMonths: 1, doseType: 'calculated', formula: "w * 100", maxDose: 4000, frequency: "once daily" }
                ]
            },
            {
                name: "Cetirizine",
                conditions: ["Urticaria", "Allergy", "Rash"],
                routes: [ { name: "Oral (PO)", bnfcLink: "https://bnfc.nice.org.uk/drugs/cetirizine-hydrochloride/", guidelines: "6m–2y: 2.5mg OD/BD. | 2–6y: 2.5mg BD or 5mg OD. | >6y: 10mg OD.", doseType: 'ageBand', tiers: [ { min: 6, max: 23, dose: "2.5mg", frequency: "once or twice daily" }, { min: 24, max: 71, dose: "2.5mg BD or 5mg OD", frequency: "" }, { min: 72, dose: "10mg", frequency: "once daily" } ] } ]
            },
            {
                name: "Chlorphenamine",
                conditions: ["Urticaria", "Allergy", "Anaphylaxis"],
                routes: [ { name: "Oral (PO)", bnfcLink: "https://bnfc.nice.org.uk/drugs/chlorphenamine-maleate/", guidelines: "1–2y: 1mg BD. | 2–6y: 1mg every 4-6h (max 6mg/d). | 6–12y: 2mg every 4-6h (max 12mg/d). | >12y: 4mg every 4-6h (max 24mg/d).", doseType: 'ageBand', tiers: [ { min: 12, max: 23, dose: "1mg", frequency: "twice daily" }, { min: 24, max: 71, dose: "1mg", frequency: "every 4-6 hours (max 6mg/day)" }, { min: 72, max: 143, dose: "2mg", frequency: "every 4-6 hours (max 12mg/day)" }, { min: 144, dose: "4mg", frequency: "every 4-6 hours (max 24mg/day)" } ] } ]
            },
            {
                name: "Clindamycin",
                conditions: ["Cellulitis", "Bone and joint infections", "Quinsy"],
                routes: [
                    { name: "Intravenous (IV) - Severe Infection", bnfcLink: "https://bnfc.nice.org.uk/drugs/clindamycin/", guidelines: "Severe infection: 10mg/kg (max 600mg) four times daily.", minAgeMonths: 1, doseType: 'calculated', formula: "w * 10", maxDose: 600, frequency: "four times daily" },
                    { name: "Oral (PO)", bnfcLink: "https://bnfc.nice.org.uk/drugs/clindamycin/", guidelines: "3–6mg/kg (max 450mg) four times daily.", minAgeMonths: 1, doseType: 'range', formula: ["w * 3", "w * 6"], maxDose: 450, frequency: "four times daily" }
                ]
            },
            {
                name: "Dexamethasone",
                conditions: ["Croup", "Asthma", "Wheeze"],
                routes: [ { name: "Oral (PO) / IM", bnfcLink: "https://bnfc.nice.org.uk/drugs/dexamethasone/", guidelines: "Croup/Asthma: Single Dose: 0.15mg/kg.", doseType: 'calculated', formula: "w * 0.15", frequency: "as a single dose (for 0.15mg/kg)" } ]
            },
            {
                name: "Flucloxacillin",
                conditions: ["Cellulitis", "Bone and joint infections"],
                routes: [
                    { name: "Intravenous (IV)", bnfcLink: "https://bnfc.nice.org.uk/drugs/flucloxacillin/", guidelines: "25-50mg/kg (max 2g) four times daily.", minAgeMonths: 1, doseType: 'range', formula: ["w * 25", "w * 50"], maxDose: 2000, frequency: "four times daily" },
                    { name: "Oral (PO)", bnfcLink: "https://bnfc.nice.org.uk/drugs/flucloxacillin/", guidelines: "12.5-25mg/kg (max 500mg) four times daily.", minAgeMonths: 1, doseType: 'range', formula: ["w * 12.5", "w * 25"], maxDose: 500, frequency: "four times daily" }
                ]
            },
            {
                name: "Gentamicin",
                conditions: ["Urinary Tract Infection (UTI)", "Pyelonephritis", "Sepsis"],
                routes: [ { name: "Intravenous (IV) - Once Daily", bnfcLink: "https://bnfc.nice.org.uk/drugs/gentamicin/", guidelines: "Once Daily Dosing (>1 month): 7mg/kg (max 420mg) once daily. Dose adjusted based on levels.", minAgeMonths: 1, doseType: 'calculated', formula: "w * 7", maxDose: 420, frequency: "once daily (Requires TDM)" } ]
            },
            {
                name: "Ibuprofen",
                conditions: ["Fever", "Pain", "Headache", "Limp"],
                routes: [ { name: "Oral (PO)", bnfcLink: "https://bnfc.nice.org.uk/drugs/ibuprofen/", guidelines: "3 months–18 years: 5–10mg/kg (max 400mg) every 6-8 hours.", minAgeMonths: 3, doseType: 'range', formula: ["w * 5", "w * 10"], maxDose: 400, frequency: "every 6-8 hours" } ]
            },
            {
                name: "Ipratropium Bromide",
                conditions: ["Acute Asthma", "Wheeze"],
                routes: [ { name: "Nebuliser", bnfcLink: "https://bnfc.nice.org.uk/drugs/ipratropium-bromide/", guidelines: "1m–12y: 250mcg. | >12y: 500mcg.", doseType: 'ageBand', frequency: "nebulised", tiers: [ { min: 1, max: 143, dose: "250mcg" }, { min: 144, dose: "500mcg" } ] } ]
            },
            {
                name: "Levetiracetam",
                conditions: ["Fits", "Seizures", "Status Epilepticus"],
                routes: [ { name: "Intravenous (IV) Loading Dose", bnfcLink: "https://bnfc.nice.org.uk/drugs/levetiracetam/", guidelines: "Loading Dose: 40-60mg/kg (max 4.5g) infused over 15 minutes.", minAgeMonths: 1, doseType: 'range', formula: ["w * 40", "w * 60"], maxDose: 4500, frequency: "infused over 15 mins" } ]
            },
            {
                name: "Lorazepam",
                conditions: ["Fits", "Seizures", "Status Epilepticus"],
                routes: [ { name: "Intravenous (IV)", bnfcLink: "https://bnfc.nice.org.uk/drugs/lorazepam/", guidelines: "0.1mg/kg (max 4mg) as a slow IV injection.", minAgeMonths: 1, doseType: 'calculated', formula: "w * 0.1", maxDose: 4, frequency: "as a slow IV injection" } ]
            },
            {
                name: "Macrogols (e.g., Movicol)",
                conditions: ["Constipation"],
                routes: [ { name: "Oral (PO) for Disimpaction", bnfcLink: "https://bnfc.nice.org.uk/drugs/macrogol-3350/", guidelines: "Disimpaction (escalating daily dose):\n- 1–5 years: Day 1=2 sachets, then add 2 daily to max 8.\n- 5–12 years: Day 1=4 sachets, then add 2 daily to max 12.", minAgeMonths: 12, doseType: 'fixedText', dose: "See guidelines below", frequency: "daily, escalating dose" } ]
            },
            {
                name: "Magnesium Sulphate",
                conditions: ["Acute Asthma", "Wheeze"],
                routes: [ { name: "Intravenous (IV)", bnfcLink: "https://bnfc.nice.org.uk/drugs/magnesium-sulfate/", guidelines: "1 month–18 years: 40mg/kg (max 2g) as a single dose infused over 20 minutes.", minAgeMonths: 1, doseType: 'calculated', formula: "w * 40", maxDose: 2000, frequency: "infused over 20 minutes" } ]
            },
            {
                name: "Nitrofurantoin",
                conditions: ["Urinary Tract Infection (UTI)"],
                routes: [ { name: "Oral (PO) for Lower UTI", bnfcLink: "https://bnfc.nice.org.uk/drugs/nitrofurantoin/", guidelines: "Lower UTI (>3 months): 750mcg/kg (max 100mg) four times daily for 3 days.", minAgeMonths: 3, doseType: 'calculated', formula: "w * 0.75", maxDose: 100, frequency: "four times daily for 3 days" } ]
            },
            {
                name: "Ondansetron",
                conditions: ["Diarrhoea and vomiting", "Vomiting"],
                routes: [ { name: "Oral (PO) / ODT", bnfcLink: "https://bnfc.nice.org.uk/drugs/ondansetron/", guidelines: "By weight: 8-15kg: 2mg | 15-30kg: 4mg | >30kg: 8mg.", minAgeMonths: 6, doseType: 'weightBand', frequency: "as a single dose", tiers: [ { min: 8, max: 15, dose: "2mg" }, { min: 15.1, max: 30, dose: "4mg" }, { min: 30.1, dose: "8mg" } ] } ]
            },
            {
                name: "Paracetamol",
                conditions: ["Fever", "Pain", "Headache", "Limp"],
                routes: [
                    { name: "Oral / Rectal (PO/PR)", bnfcLink: "https://bnfc.nice.org.uk/drugs/paracetamol/", guidelines: "1–3m: 30–60mg every 8h. | >3m: 15mg/kg (max 1g) every 4-6h.", doseType: 'ageBand', tiers: [ { min: 1, max: 2, dose: "30-60mg", frequency: "every 8 hours" }, { min: 3, doseType: 'calculated', formula: "w * 15", maxDose: 1000, frequency: "every 4-6 hours" } ] },
                    { name: "Intravenous (IV)", bnfcLink: "https://bnfc.nice.org.uk/drugs/paracetamol/", guidelines: "<50kg: 15mg/kg (max 750mg) every 6h. | ≥50kg: 1g every 6h.", doseType: 'weightBand', tiers: [ { max: 49.9, doseType: 'calculated', formula: "w * 15", maxDose: 750, frequency: "every 6 hours" }, { min: 50, dose: "1g", frequency: "every 6 hours" } ] }
                ]
            },
            {
                name: "Phenoxymethylpenicillin (Pen V)",
                conditions: ["Tonsillitis"],
                routes: [ { name: "Oral (PO)", bnfcLink: "https://bnfc.nice.org.uk/drugs/phenoxymethylpenicillin/", guidelines: "1m–6y: 125mg QDS | 6–12y: 250mg QDS | >12y: 500mg QDS.", doseType: 'ageBand', frequency: "four times daily", tiers: [ { min: 1, max: 71, dose: "125mg" }, { min: 72, max: 143, dose: "250mg" }, { min: 144, dose: "500mg" } ] } ]
            },
            {
                name: "Prednisolone",
                conditions: ["Acute Asthma", "Wheeze"],
                routes: [ { name: "Oral (PO) for Asthma", bnfcLink: "https://bnfc.nice.org.uk/drugs/prednisolone/", guidelines: "1m–2y: 10mg OD. | 2–5y: 20mg OD. | >5y: 30–40mg OD.", doseType: 'ageBand', frequency: "once daily for 3-5 days", tiers: [ { min: 1, max: 23, dose: "10mg" }, { min: 24, max: 59, dose: "20mg" }, { min: 60, dose: "30-40mg" } ] } ]
            },
            {
                name: "Salbutamol",
                conditions: ["Asthma", "Wheeze"],
                routes: [
                    { name: "MDI + Spacer", bnfcLink: "https://bnfc.nice.org.uk/drugs/salbutamol/", guidelines: "1 month–18 years: 2-10 puffs via spacer, repeat as needed.", minAgeMonths: 1, doseType: 'fixedText', dose: "2-10 puffs", frequency: "repeat as clinically required" },
                    { name: "Nebuliser", bnfcLink: "https://bnfc.nice.org.uk/drugs/salbutamol/", guidelines: "1m–5y: 2.5mg. | >5y: 5mg.", doseType: 'ageBand', frequency: "nebulised", tiers: [ { min: 1, max: 59, dose: "2.5mg" }, { min: 60, dose: "5mg" } ] }
                ]
            },
            {
                name: "Trimethoprim",
                conditions: ["Urinary Tract Infection (UTI)"],
                routes: [ { name: "Oral (PO) for Lower UTI", bnfcLink: "https://bnfc.nice.org.uk/drugs/trimethoprim/", guidelines: "Lower UTI (>3 months): 4mg/kg (max 200mg) twice daily for 3 days.", minAgeMonths: 3, doseType: 'calculated', formula: "w * 4", maxDose: 200, frequency: "twice daily for 3 days" } ]
            }
        ];

        let appData = [];
        let currentDrug = null;
        let ageSyncSource = null;

        const el = (id) => document.getElementById(id);
        const mainView = el('main-view'), calculatorView = el('calculator-view'), searchBox = el('search-box');
        const resultsList = el('results-list'), backBtn = el('back-to-search-btn'), calculatorTitle = el('calculator-title');
        const weightInput = el('weight-input'), ageYearsInput = el('age-years-input'), ageMonthsInput = el('age-months-input');
        const clearInputsBtn = el('clear-inputs-btn'), doseResultsContainer = el('dose-results-container');
        const settingsModal = el('settings-modal'), openSettingsBtn = el('open-settings-btn'), closeSettingsBtn = el('close-settings-btn');
        const saveDataBtn = el('save-data-btn'), resetDataBtn = el('reset-data-btn'), jsonEditor = el('json-editor');

        const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; };
        const formatNumber = (num) => Math.round(num * 10) / 10;

        function calculateDose(route, w, a) {
            const safeEval = (formula) => new Function('w', 'a', `return ${formula}`)(w, a);
            const getTier = (tiers, key) => tiers.find(t => (t.min === undefined || key >= t.min) && (t.max === undefined || key <= t.max));

            if (route.minAgeMonths && a < route.minAgeMonths) return { displayValue: 'Too Young', reason: `Min age for this route is ${route.minAgeMonths} months.` };
            
            let result = { displayValue: '---', reason: 'Enter weight and age.', isCapped: false };
            let finalDose = null, isCapped = false;
            let unit = route.unit ?? 'mg';

            const processDose = (dose, freq, max, reasonPrefix = "Based on") => {
                let displayDose = dose;
                if (typeof dose === 'number') {
                    if (max && dose > max) {
                        displayDose = max;
                        isCapped = true;
                        result.reason = `Calculated dose (${formatNumber(dose)}${unit}) exceeds max dose of ${max}${unit}.`;
                    } else {
                        result.reason = `${reasonPrefix} age ${a}m, weight ${w}kg.`;
                    }
                    finalDose = `${formatNumber(displayDose)}${unit} ${freq}`;
                } else {
                    finalDose = `${dose} ${freq}`;
                    result.reason = `${reasonPrefix} age ${a}m, weight ${w}kg.`;
                }
                result.displayValue = finalDose;
                result.isCapped = isCapped;
            };

            switch (route.doseType) {
                case 'calculated':
                    processDose(safeEval(route.formula), route.frequency, route.maxDose);
                    break;
                case 'range':
                    const low = safeEval(route.formula[0]);
                    const high = safeEval(route.formula[1]);
                    if (route.maxDose && high > route.maxDose) isCapped = true;
                    const displayHigh = route.maxDose ? Math.min(high, route.maxDose) : high;
                    const rangeStr = `${formatNumber(low)}-${formatNumber(displayHigh)}${unit}`;
                    processDose(rangeStr, route.frequency, null, "Range based on");
                    if (isCapped) result.reason = `Upper range (${formatNumber(high)}${unit}) capped by max dose of ${route.maxDose}${unit}.`;
                    break;
                case 'fixedText':
                    processDose(route.dose, route.frequency, null, "Fixed dose for");
                    break;
                case 'ageBand':
                case 'weightBand':
                    const key = route.doseType === 'ageBand' ? a : w;
                    const tier = getTier(route.tiers, key);
                    if (tier) {
                        if (tier.doseType === 'calculated') { // Handle nested calculated types (like Paracetamol)
                           processDose(safeEval(tier.formula), tier.frequency, tier.maxDose);
                        } else {
                           processDose(tier.dose, tier.frequency || route.frequency, null, "Fixed dose for");
                        }
                    } else { result = { displayValue: 'Out of Range' }; }
                    break;
                default: result.reason = 'Unknown dose type.';
            }
            return result;
        }

        const renderDoseCards = debounce(() => {
            if (!currentDrug) return;
            doseResultsContainer.innerHTML = '';
            const weight = parseFloat(weightInput.value);
            const ageYears = parseInt(ageYearsInput.value) || 0;
            const ageMonths = parseInt(ageMonthsInput.value) || 0;
            const totalMonths = (ageYears * 12) + ageMonths;

            if (isNaN(weight) || weight <= 0 || totalMonths < 0) {
                doseResultsContainer.innerHTML = `<p class="no-results">Please enter a valid weight and age.</p>`;
                return;
            }

            currentDrug.routes.forEach(route => {
                const card = document.createElement('div');
                card.className = 'dose-result-card';
                const { displayValue, reason, isCapped } = calculateDose(route, weight, totalMonths);
                
                card.innerHTML = `
                    <h4>${route.name}</h4>
                    <div class="dose-output">
                        <div class="calculated-dose">
                            <div class="label">Calculated Dose</div>
                            <div class="value ${isCapped ? 'is-capped' : ''}">${displayValue}</div>
                        </div>
                        <button class="copy-btn" aria-label="Copy dose" title="Copy Dose">Copy</button>
                    </div>
                    <p class="dose-reason">${reason || ''}</p>
                    <h5>BNFc Reference Guideline:</h5>
                    <pre class="bnfc-ref">${route.guidelines}</pre>
                    <a href="${route.bnfcLink}" target="_blank" rel="noopener noreferrer" class="bnfc-link">Open BNFc Link &rarr;</a>`;
                
                const copyButton = card.querySelector('.copy-btn');
                copyButton.addEventListener('click', () => {
                    navigator.clipboard.writeText(displayValue).then(() => {
                        copyButton.textContent = 'Copied!';
                        setTimeout(() => { copyButton.textContent = 'Copy'; }, 1500);
                    });
                });
                doseResultsContainer.appendChild(card);
            });
        }, 300);

        function syncAgeInputs(source) {
            ageSyncSource = source;
            const years = parseInt(ageYearsInput.value) || 0;
            const months = parseInt(ageMonthsInput.value) || 0;
            if (source === 'months' && months >= 12) {
                ageYearsInput.value = Math.floor(months / 12);
                ageMonthsInput.value = months % 12;
            } else if (source === 'years') {
                // No action needed if years are the source, months are additive
            }
            ageSyncSource = null;
            renderDoseCards();
        }

        function loadData() {
            const storedData = localStorage.getItem('paedsDrugData');
            appData = storedData ? JSON.parse(storedData) : defaultDrugData;
            appData.sort((a, b) => a.name.localeCompare(b.name));
        }

        function renderResults(query = '') {
            resultsList.innerHTML = '';
            const lowerCaseQuery = query.toLowerCase();
            const filteredData = appData.filter(drug => 
                drug.name.toLowerCase().includes(lowerCaseQuery) ||
                drug.conditions.some(condition => condition.toLowerCase().includes(lowerCaseQuery))
            );
            const dataToRender = query ? filteredData : appData;
            if (dataToRender.length === 0) {
                resultsList.innerHTML = `<div class="no-results"><h3>No results found</h3><p>Try a different drug or condition name.</p></div>`;
                return;
            }
            dataToRender.forEach(drug => {
                const card = document.createElement('div');
                card.className = 'drug-card';
                card.dataset.drugName = drug.name;
                card.innerHTML = `<h3>${drug.name}</h3><p>${drug.conditions.join(', ')}</p>`;
                card.addEventListener('click', () => showCalculator(drug.name));
                resultsList.appendChild(card);
            });
        }

        function showCalculator(drugName) {
            currentDrug = appData.find(d => d.name === drugName);
            if (!currentDrug) return;
            mainView.classList.add('hidden');
            calculatorView.classList.remove('hidden');
            calculatorView.style.display = 'block';
            calculatorTitle.textContent = currentDrug.name;
            weightInput.value = '';
            ageYearsInput.value = '';
            ageMonthsInput.value = '';
            doseResultsContainer.innerHTML = `<p class="no-results">Enter weight and age to calculate dose.</p>`;
            weightInput.focus();
        }
        
        const showMainView = () => { calculatorView.style.display = 'none'; mainView.classList.remove('hidden'); searchBox.focus(); };
        const openSettings = () => { jsonEditor.value = JSON.stringify(appData, null, 2); settingsModal.style.display = 'flex'; };
        const closeSettings = () => { settingsModal.style.display = 'none'; };
        const saveData = () => { try { appData = JSON.parse(jsonEditor.value); localStorage.setItem('paedsDrugData', JSON.stringify(appData)); loadData(); renderResults(searchBox.value); closeSettings(); } catch (e) { alert('Error: Invalid JSON format. Changes not saved.'); }};
        const resetData = () => { if (confirm('Are you sure you want to reset all dosages to defaults?')) { localStorage.removeItem('paedsDrugData'); loadData(); renderResults(searchBox.value); closeSettings(); }};
        const clearInputs = () => { weightInput.value = ''; ageYearsInput.value = ''; ageMonthsInput.value = ''; renderDoseCards(); weightInput.focus(); };

        searchBox.addEventListener('input', () => renderResults(searchBox.value));
        backBtn.addEventListener('click', showMainView);
        weightInput.addEventListener('input', renderDoseCards);
        ageYearsInput.addEventListener('input', () => { if (!ageSyncSource) syncAgeInputs('years'); });
        ageMonthsInput.addEventListener('input', () => { if (!ageSyncSource) syncAgeInputs('months'); });
        clearInputsBtn.addEventListener('click', clearInputs);
        openSettingsBtn.addEventListener('click', openSettings);
        closeSettingsBtn.addEventListener('click', closeSettings);
        saveDataBtn.addEventListener('click', saveData);
        resetDataBtn.addEventListener('click', resetData);
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettings(); });
        
        loadData();
        renderResults();
    });
    </script>
</body>
</html>