<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Paediatric Emergency Dosing Calculator">
    <meta name="description" content="Mobile-first paediatric emergency dosing calculator with editable drug and observation data.">
    <meta property="og:title" content="Paediatric Emergency Dosing Calculator">
    <meta property="og:description" content="Mobile-first paediatric emergency dosing calculator with editable drug and observation data.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/favicon.svg">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg width='32' height='32' viewBox='0 0 32 32' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='32' height='32' rx='8' fill='%230f172a'/%3E%3Cpath d='M16 7v18M7 16h18' stroke='%2338bdf8' stroke-width='2.5' stroke-linecap='round'/%3E%3Ccircle cx='16' cy='16' r='7' stroke='%234ade80' stroke-width='2'/%3E%3C/svg%3E">
    <title>Paediatric Emergency Dosing Calculator</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --surface-color: #1e293b;
            --primary-color: #38bdf8;
            --text-color: #e2e8f0;
            --text-muted-color: #94a3b8;
            --border-color: #334155;
            --success-color: #4ade80;
            --warning-color: #facc15;
            --danger-color: #f87171;
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            font-family: var(--font-sans);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            font-size: 16px;
            min-height: 100vh;
            min-width: 100vw;
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            min-height: 100vh;
            min-width: 100vw;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: var(--bg-color);
        }
        .container {
            width: 100vw;
            min-height: 100vh;
            max-width: 480px;
            margin: 0 auto;
            padding: 24px 0 40px 0;
            background: rgba(30,41,59,0.98);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            gap: 24px;
            border-radius: 0;
            box-shadow: none;
        }
        @media (min-width: 900px) {
            .container {
                max-width: 900px;
                margin: 40px auto;
                border-radius: 18px;
                padding: 32px 0 56px 0;
                box-shadow: 0 8px 40px 0 rgba(16,24,40,0.18);
                gap: 32px;
            }
        }
        .header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(30,41,59,0.98);
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 24px 18px 16px 18px;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 8px 0 rgba(16,24,40,0.06);
        }
        @media (min-width: 900px) {
            .header {
                padding: 36px 36px 24px 36px;
                font-size: 1.2rem;
                margin-bottom: 32px;
            }
        }
        .header h1 {
            font-size: 1.7rem;
            font-weight: 700;
            color: #fff;
            margin: 0 0 0 8px;
            letter-spacing: -0.5px;
        }
        @media (min-width: 900px) {
            .header h1 {
                font-size: 2.2rem;
            }
        }
        .header .app-icon {
            width: 36px;
            height: 36px;
            display: inline-block;
            vertical-align: middle;
        }
        .settings-btn {
            background: none;
            border: 1.5px solid var(--border-color);
            color: var(--primary-color);
            padding: 10px 14px;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            margin-left: auto;
            font-size: 1.15rem;
        }
        .settings-btn:hover {
            background-color: var(--surface-color);
            color: var(--success-color);
            border-color: var(--primary-color);
        }
        .disclaimer {
            background-color: rgba(248, 113, 113, 0.1);
            border: 1px solid var(--danger-color);
            color: #fca5a5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 32px;
            font-size: 1rem;
        }
        .disclaimer strong { color: #f87171; display: block; margin-bottom: 8px; }
        .search-box {
            width: 100%;
            padding: 20px 22px;
            font-size: 1.15rem;
            background-color: var(--bg-color);
            border: 1.5px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-color);
            margin-bottom: 32px;
            margin-top: 0;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 4px rgba(16,24,40,0.04);
        }
        @media (min-width: 900px) {
            .search-box {
                font-size: 1.25rem;
                padding: 24px 32px;
                margin-bottom: 40px;
            }
        }
        .search-box:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.18);
        }
        .results-list {
            display: grid;
            gap: 20px;
            margin: 0 18px 24px 18px;
        }
        @media (min-width: 900px) {
            .results-list {
                grid-template-columns: 1fr 1fr;
                gap: 32px;
                margin: 0 36px 32px 36px;
            }
        }
        .drug-card {
            background-color: var(--surface-color);
            border: 1.5px solid var(--border-color);
            padding: 24px 20px;
            border-radius: 14px;
            cursor: pointer;
            transition: border-color 0.2s, transform 0.2s, box-shadow 0.2s;
            will-change: transform;
            box-shadow: 0 2px 12px rgba(16,24,40,0.08);
        }
        @media (min-width: 900px) {
            .drug-card {
                padding: 36px 28px;
                font-size: 1.1rem;
            }
        }
        .drug-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-3px) scale(1.015);
            box-shadow: 0 6px 20px rgba(56,189,248,0.10);
        }
        .drug-card h3 {
            font-size: 1.15rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 6px;
        }
        @media (min-width: 900px) {
            .drug-card h3 {
                font-size: 1.3rem;
            }
        }
        .drug-card p {
            font-size: 1rem;
            color: var(--text-muted-color);
        }
        @media (min-width: 900px) {
            .drug-card p {
                font-size: 1.08rem;
            }
        }
        #calculator-view { display: none; }
        .calculator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 0 0 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .back-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.05rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px;
        }
        .calculator-title {
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
        }
        .patient-input-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .weight-input-group { display: flex; }
        .age-input-group { display: flex; gap: 12px; }
        .input-field label {
            display: block;
            font-size: 1rem;
            color: var(--text-muted-color);
            margin-bottom: 8px;
        }
        .input-field input {
            width: 100%;
            padding: 14px;
            background-color: var(--bg-color);
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            font-size: 1.05rem;
            -moz-appearance: textfield;
        }
        .input-field input::-webkit-outer-spin-button, .input-field input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .input-actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 32px;
        }
        .clear-btn {
            background: none;
            border: none;
            color: var(--text-muted-color);
            font-size: 1rem;
            cursor: pointer;
            transition: color 0.2s;
            padding: 6px 12px;
            border-radius: 6px;
        }
        .clear-btn:hover { color: var(--primary-color); background: var(--surface-color); }
        .dose-result-card {
            background-color: var(--surface-color);
            border: 1.5px solid var(--border-color);
            padding: 28px 20px 20px 20px;
            border-radius: 14px;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(16,24,40,0.08);
        }
        .dose-result-card h4 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--primary-color);
        }
        .dose-output {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 18px;
            gap: 16px;
        }
        .calculated-dose .label { font-size: 1rem; color: var(--text-muted-color); }
        .calculated-dose .value { font-size: 2.1rem; font-weight: 700; color: var(--success-color); }
        .calculated-dose .value.is-capped { color: var(--warning-color); }
        .copy-btn {
            background-color: var(--border-color);
            border: none;
            color: var(--text-color);
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 1rem;
        }
        .copy-btn:hover { background-color: #475569; }
        .dose-reason { font-size: 0.95rem; color: var(--text-muted-color); font-style: italic; margin-bottom: 18px; }
        .bnfc-ref { font-size: 1rem; background-color: var(--bg-color); padding: 14px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; margin-bottom: 18px; }
        .bnfc-link { display: inline-block; background-color: var(--primary-color); color: #0f172a; padding: 12px 20px; text-decoration: none; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; font-size: 1rem; }
        .bnfc-link:hover { background-color: #7dd3fc; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 24px;
        }
        .modal-content {
            background-color: var(--surface-color);
            padding: 32px 24px 24px 24px;
            border-radius: 16px;
            width: 95%;
            max-width: 700px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            border: 1.5px solid var(--border-color);
            gap: 12px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }
        .modal-header h2 { font-size: 1.6rem; color: #fff; }
        .close-btn { background: none; border: none; color: var(--text-muted-color); font-size: 1.7rem; cursor: pointer; }
        .modal-body { flex-grow: 1; overflow-y: auto; }
        #json-editor {
            width: 100%;
            height: 400px;
            background-color: var(--bg-color);
            border: 1.5px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            font-size: 1rem;
            padding: 14px;
        }
        .modal-footer {
            margin-top: 18px;
            display: flex;
            justify-content: flex-end;
            gap: 16px;
        }
        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: opacity 0.2s;
            font-size: 1rem;
        }
        .modal-btn:hover { opacity: 0.9; }
        .save-btn { background-color: var(--primary-color); color: #0f172a; font-weight: 600; }
        .reset-btn { background-color: var(--danger-color); color: #fff; }
        .hidden { display: none !important; }
        .no-results { text-align: center; padding: 28px; color: var(--text-muted-color); font-size: 1.1rem; }
        @media (min-width: 600px) { .patient-input-grid { grid-template-columns: 1fr 1.5fr; } }
        /* --- Observations Reference --- */
        .observations-ref {
            background: var(--surface-color);
            border-radius: 14px;
            padding: 20px 14px;
            margin-bottom: 28px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.06);
        }
        .obs-age-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .obs-age-group {
            display: flex;
            flex-direction: column;
            flex: 1 1 90px;
            min-width: 90px;
        }
        .obs-age-group label {
            color: var(--text-muted-color);
            font-size: 1rem;
            margin-bottom: 4px;
        }
        .obs-age-group input {
            padding: 12px;
            font-size: 1.1rem;
            border-radius: 10px;
            border: 1.5px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
        }
        .obs-values-card {
            display: flex;
            gap: 20px;
            align-items: center;
            background: var(--bg-color);
            border-radius: 10px;
            padding: 12px 16px;
            margin-top: 10px;
            font-size: 1.1rem;
            flex-wrap: wrap;
        }
        .obs-value-label {
            color: var(--text-muted-color);
            font-size: 1rem;
            margin-right: 2px;
        }
        .obs-value-main {
            font-weight: 700;
            font-size: 1.1rem;
            margin-right: 8px;
        }
        .obs-band-label {
            color: var(--text-muted-color);
            font-size: 1rem;
            margin-left: 10px;
        }
        .obs-edit-btn {
            margin-left: auto;
            background: none;
            border: 1.5px solid var(--border-color);
            color: var(--primary-color);
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 1.05rem;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .obs-edit-btn:active, .obs-edit-btn:hover {
            background: var(--primary-color);
            color: var(--bg-color);
        }
        @media (max-width: 600px) {
            .observations-ref {
                padding: 14px 6px;
            }
            .obs-age-row {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .obs-values-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                font-size: 1rem;
            }
            .obs-edit-btn {
                width: 100%;
                margin: 10px 0 0 0;
            }
        }
        /* --- End Observations Reference --- */
        #error-banner {
            display: none;
            background: #f87171;
            color: #fff;
            padding: 16px 24px;
            border-radius: 10px;
            margin: 0 18px 24px 18px;
            font-weight: 600;
            font-size: 1.1rem;
            box-shadow: 0 2px 8px rgba(16,24,40,0.10);
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="main-view">
            <header class="header">
                <span class="app-icon" aria-label="Medical cross icon">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" rx="8" fill="#0f172a"/>
                        <path d="M16 7v18M7 16h18" stroke="#38bdf8" stroke-width="2.5" stroke-linecap="round"/>
                        <circle cx="16" cy="16" r="7" stroke="#4ade80" stroke-width="2"/>
                    </svg>
                </span>
                <h1>Paeds Dosing</h1>
                <button class="settings-btn" id="open-settings-btn" title="Edit Dosages" aria-label="Edit Dosages">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-4.44a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.88z"></path><path d="M18 2v6h6"></path><path d="m12 18-2-2 4-4-2-2"></path><path d="m18 12-2-2-4 4-2-2"></path></svg>
                </button>
            </header>
            <div id="observations-ref" class="observations-ref"></div>
            <input type="text" id="search-box" class="search-box" placeholder="Search drug or condition (e.g., 'Croup')">
            <div id="results-list" class="results-list"></div>
        </div>
        <div id="calculator-view">
            <div class="calculator-header"><button class="back-btn" id="back-to-search-btn" aria-label="Back to search"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>Back</button><h2 id="calculator-title" class="calculator-title"></h2></div>
            <div class="patient-input-grid">
                <div class="input-field"><label for="weight-input">Weight (kg)</label><div class="weight-input-group"><input type="number" id="weight-input" placeholder="e.g., 15"></div></div>
                <div class="input-field"><label>Age</label><div class="age-input-group"><input type="number" id="age-years-input" placeholder="Years"><input type="number" id="age-months-input" placeholder="Months"></div></div>
            </div>
            <div class="input-actions"><button id="clear-inputs-btn" class="clear-btn">Clear Inputs</button></div>
            <div id="dose-results-container"></div>
        </div>
    </div>
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h2>Edit Dosage Data (JSON)</h2><button id="close-settings-btn" class="close-btn" aria-label="Close settings">&times;</button></div>
            <div class="modal-body"><p style="font-size: 0.9rem; color: var(--text-muted-color); margin-bottom: 10px;">Warning: Changes here are saved locally and will affect all calculations. Edit with caution.</p><textarea id="json-editor"></textarea></div>
            <div class="modal-footer"><button id="reset-data-btn" class="modal-btn reset-btn">Reset to Defaults</button><button id="save-data-btn" class="modal-btn save-btn">Save and Close</button></div>
        </div>
    </div>
    <div id="error-banner" style="display:none;background:#f87171;color:#fff;padding:12px 16px;border-radius:8px;margin-bottom:16px;font-weight:600;"></div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ERROR HANDLING ---
        const showError = (msg) => {
            const banner = document.getElementById('error-banner');
            if (banner) {
                banner.textContent = msg;
                banner.style.display = 'block';
            } else {
                alert(msg);
            }
        };
        // --- DATA STORE ---
        // 'a' = total age in months, 'w' = weight in kg
        // doseType: calculated, range, fixedText, ageBand, weightBand
        const defaultDrugData = [
            {
                name: "Adrenaline (Epinephrine) 1:1000",
                conditions: ["Croup", "Anaphylaxis"],
                routes: [ { name: "Nebuliser (for Croup)", bnfcLink: "https://bnfc.nice.org.uk/drugs/adrenaline-epinephrine/", guidelines: "0.5mL/kg (max 5mL) of 1:1000 adrenaline for moderate-severe croup.", doseType: 'calculated', unit: 'mL', formula: "w * 0.5", maxDose: 5, frequency: "nebulised" } ]
            },
            {
                name: "Amoxicillin",
                conditions: ["Community Acquired Pneumonia (CAP)", "Pneumonia", "Lyme Disease"],
                routes: [ { name: "Oral (PO) for CAP", bnfcLink: "https://bnfc.nice.org.uk/drugs/amoxicillin/", guidelines: "1 month–18 years: 30mg/kg (max 1g) three times daily.", minAgeMonths: 1, doseType: 'calculated', formula: "w * 30", maxDose: 1000, frequency: "three times daily" } ]
            },
            {
                name: "Buccal Midazolam",
                conditions: ["Fits", "Seizures", "Status Epilepticus"],
                routes: [ { name: "Buccal", bnfcLink: "https://bnfc.nice.org.uk/drugs/midazolam/", guidelines: "By Age Band: 6m–1y: 2.5mg | 1–5y: 5mg | 5–10y: 7.5mg | >10y: 10mg. Single STAT dose.", doseType: 'ageBand', frequency: "STAT", tiers: [ { min: 6, max: 11, dose: "2.5mg" }, { min: 12, max: 59, dose: "5mg" }, { min: 60, max: 119, dose: "7.5mg" }, { min: 120, dose: "10mg" } ] } ]
            },
            {
                name: "Cefalexin",
                conditions: ["Urinary Tract Infection (UTI)", "Pyelonephritis"],
                routes: [ { name: "Oral (PO) for Pyelonephritis", bnfcLink: "https://bnfc.nice.org.uk/drugs/cefalexin/", guidelines: "Pyelonephritis (>3 months): 12.5–25mg/kg (max 500mg) two-three times daily for 7-10 days.", minAgeMonths: 3, doseType: 'range', formula: ["w * 12.5", "w * 25"], maxDose: 500, frequency: "two-three times daily" } ]
            },
            {
                name: "Ceftriaxone",
                conditions: ["Sepsis", "Meningitis", "Petechial Rash", "Pneumonia"],
                routes: [
                    { name: "IV / IM - Sepsis of unknown origin", bnfcLink: "https://bnfc.nice.org.uk/drugs/ceftriaxone/", guidelines: "Sepsis of unknown origin (>1 month): 80mg/kg (max 4g) once daily.", minAgeMonths: 1, doseType: 'calculated', formula: "w * 80", maxDose: 4000, frequency: "once daily" },
                    { name: "IV / IM - Confirmed Meningitis", bnfcLink: "https://bnfc.nice.org.uk/drugs/ceftriaxone/", guidelines: "Confirmed Meningitis: 100mg/kg (max 4g) once daily.", minAgeMonths: 1, doseType: 'calculated', formula: "w * 100", maxDose: 4000, frequency: "once daily" }
                ]
            },
            {
                name: "Cetirizine",
                conditions: ["Urticaria", "Allergy", "Rash"],
                routes: [ { name: "Oral (PO)", bnfcLink: "https://bnfc.nice.org.uk/drugs/cetirizine-hydrochloride/", guidelines: "6m–2y: 2.5mg OD/BD. | 2–6y: 2.5mg BD or 5mg OD. | >6y: 10mg OD.", doseType: 'ageBand', tiers: [ { min: 6, max: 23, dose: "2.5mg", frequency: "once or twice daily" }, { min: 24, max: 71, dose: "2.5mg BD or 5mg OD", frequency: "" }, { min: 72, dose: "10mg", frequency: "once daily" } ] } ]
            },
            {
                name: "Chlorphenamine",
                conditions: ["Urticaria", "Allergy", "Anaphylaxis"],
                routes: [ { name: "Oral (PO)", bnfcLink: "https://bnfc.nice.org.uk/drugs/chlorphenamine-maleate/", guidelines: "1–2y: 1mg BD. | 2–6y: 1mg every 4-6h (max 6mg/d). | 6–12y: 2mg every 4-6h (max 12mg/d). | >12y: 4mg every 4-6h (max 24mg/d).", doseType: 'ageBand', tiers: [ { min: 12, max: 23, dose: "1mg", frequency: "twice daily" }, { min: 24, max: 71, dose: "1mg", frequency: "every 4-6 hours (max 6mg/day)" }, { min: 72, max: 143, dose: "2mg", frequency: "every 4-6 hours (max 12mg/day)" }, { min: 144, dose: "4mg", frequency: "every 4-6 hours (max 24mg/day)" } ] } ]
            },
            {
                name: "Clindamycin",
                conditions: ["Cellulitis", "Bone and joint infections", "Quinsy"],
                routes: [
                    { name: "Intravenous (IV) - Severe Infection", bnfcLink: "https://bnfc.nice.org.uk/drugs/clindamycin/", guidelines: "Severe infection: 10mg/kg (max 600mg) four times daily.", minAgeMonths: 1, doseType: 'calculated', formula: "w * 10", maxDose: 600, frequency: "four times daily" },
                    { name: "Oral (PO)", bnfcLink: "https://bnfc.nice.org.uk/drugs/clindamycin/", guidelines: "3–6mg/kg (max 450mg) four times daily.", minAgeMonths: 1, doseType: 'range', formula: ["w * 3", "w * 6"], maxDose: 450, frequency: "four times daily" }
                ]
            },
            {
                name: "Dexamethasone",
                conditions: ["Croup", "Asthma", "Wheeze"],
                routes: [ { name: "Oral (PO) / IM", bnfcLink: "https://bnfc.nice.org.uk/drugs/dexamethasone/", guidelines: "Croup/Asthma: Single Dose: 0.15mg/kg.", doseType: 'calculated', formula: "w * 0.15", frequency: "as a single dose (for 0.15mg/kg)" } ]
            },
            {
                name: "Flucloxacillin",
                conditions: ["Cellulitis", "Bone and joint infections"],
                routes: [
                    { name: "Intravenous (IV)", bnfcLink: "https://bnfc.nice.org.uk/drugs/flucloxacillin/", guidelines: "25-50mg/kg (max 2g) four times daily.", minAgeMonths: 1, doseType: 'range', formula: ["w * 25", "w * 50"], maxDose: 2000, frequency: "four times daily" },
                    { name: "Oral (PO)", bnfcLink: "https://bnfc.nice.org.uk/drugs/flucloxacillin/", guidelines: "12.5-25mg/kg (max 500mg) four times daily.", minAgeMonths: 1, doseType: 'range', formula: ["w * 12.5", "w * 25"], maxDose: 500, frequency: "four times daily" }
                ]
            },
            {
                name: "Gentamicin",
                conditions: ["Urinary Tract Infection (UTI)", "Pyelonephritis", "Sepsis"],
                routes: [ { name: "Intravenous (IV) - Once Daily", bnfcLink: "https://bnfc.nice.org.uk/drugs/gentamicin/", guidelines: "Once Daily Dosing (>1 month): 7mg/kg (max 420mg) once daily. Dose adjusted based on levels.", minAgeMonths: 1, doseType: 'calculated', formula: "w * 7", maxDose: 420, frequency: "once daily (Requires TDM)" } ]
            },
            {
                name: "Ibuprofen",
                conditions: ["Fever", "Pain", "Headache", "Limp"],
                routes: [ { name: "Oral (PO)", bnfcLink: "https://bnfc.nice.org.uk/drugs/ibuprofen/", guidelines: "3 months–18 years: 5–10mg/kg (max 400mg) every 6-8 hours.", minAgeMonths: 3, doseType: 'range', formula: ["w * 5", "w * 10"], maxDose: 400, frequency: "every 6-8 hours" } ]
            },
            {
                name: "Ipratropium Bromide",
                conditions: ["Acute Asthma", "Wheeze"],
                routes: [ { name: "Nebuliser", bnfcLink: "https://bnfc.nice.org.uk/drugs/ipratropium-bromide/", guidelines: "1m–12y: 250mcg. | >12y: 500mcg.", doseType: 'ageBand', frequency: "nebulised", tiers: [ { min: 1, max: 143, dose: "250mcg" }, { min: 144, dose: "500mcg" } ] } ]
            },
            {
                name: "Levetiracetam",
                conditions: ["Fits", "Seizures", "Status Epilepticus"],
                routes: [ { name: "Intravenous (IV) Loading Dose", bnfcLink: "https://bnfc.nice.org.uk/drugs/levetiracetam/", guidelines: "Loading Dose: 40-60mg/kg (max 4.5g) infused over 15 minutes.", minAgeMonths: 1, doseType: 'range', formula: ["w * 40", "w * 60"], maxDose: 4500, frequency: "infused over 15 mins" } ]
            },
            {
                name: "Lorazepam",
                conditions: ["Fits", "Seizures", "Status Epilepticus"],
                routes: [ { name: "Intravenous (IV)", bnfcLink: "https://bnfc.nice.org.uk/drugs/lorazepam/", guidelines: "0.1mg/kg (max 4mg) as a slow IV injection.", minAgeMonths: 1, doseType: 'calculated', formula: "w * 0.1", maxDose: 4, frequency: "as a slow IV injection" } ]
            },
            {
                name: "Macrogols (e.g., Movicol)",
                conditions: ["Constipation"],
                routes: [ { name: "Oral (PO) for Disimpaction", bnfcLink: "https://bnfc.nice.org.uk/drugs/macrogol-3350/", guidelines: "Disimpaction (escalating daily dose):\n- 1–5 years: Day 1=2 sachets, then add 2 daily to max 8.\n- 5–12 years: Day 1=4 sachets, then add 2 daily to max 12.", minAgeMonths: 12, doseType: 'fixedText', dose: "See guidelines below", frequency: "daily, escalating dose" } ]
            },
            {
                name: "Magnesium Sulphate",
                conditions: ["Acute Asthma", "Wheeze"],
                routes: [ { name: "Intravenous (IV)", bnfcLink: "https://bnfc.nice.org.uk/drugs/magnesium-sulfate/", guidelines: "1 month–18 years: 40mg/kg (max 2g) as a single dose infused over 20 minutes.", minAgeMonths: 1, doseType: 'calculated', formula: "w * 40", maxDose: 2000, frequency: "infused over 20 minutes" } ]
            },
            {
                name: "Nitrofurantoin",
                conditions: ["Urinary Tract Infection (UTI)"],
                routes: [ { name: "Oral (PO) for Lower UTI", bnfcLink: "https://bnfc.nice.org.uk/drugs/nitrofurantoin/", guidelines: "Lower UTI (>3 months): 750mcg/kg (max 100mg) four times daily for 3 days.", minAgeMonths: 3, doseType: 'calculated', formula: "w * 0.75", maxDose: 100, frequency: "four times daily for 3 days" } ]
            },
            {
                name: "Ondansetron",
                conditions: ["Diarrhoea and vomiting", "Vomiting"],
                routes: [ { name: "Oral (PO) / ODT", bnfcLink: "https://bnfc.nice.org.uk/drugs/ondansetron/", guidelines: "By weight: 8-15kg: 2mg | 15-30kg: 4mg | >30kg: 8mg.", minAgeMonths: 6, doseType: 'weightBand', frequency: "as a single dose", tiers: [ { min: 8, max: 15, dose: "2mg" }, { min: 15.1, max: 30, dose: "4mg" }, { min: 30.1, dose: "8mg" } ] } ]
            },
            {
                name: "Paracetamol",
                conditions: ["Fever", "Pain", "Headache", "Limp"],
                routes: [
                    { name: "Oral / Rectal (PO/PR)", bnfcLink: "https://bnfc.nice.org.uk/drugs/paracetamol/", guidelines: "1–3m: 30–60mg every 8h. | >3m: 15mg/kg (max 1g) every 4-6h.", doseType: 'ageBand', tiers: [ { min: 1, max: 2, dose: "30-60mg", frequency: "every 8 hours" }, { min: 3, doseType: 'calculated', formula: "w * 15", maxDose: 1000, frequency: "every 4-6 hours" } ] },
                    { name: "Intravenous (IV)", bnfcLink: "https://bnfc.nice.org.uk/drugs/paracetamol/", guidelines: "<50kg: 15mg/kg (max 750mg) every 6h. | ≥50kg: 1g every 6h.", doseType: 'weightBand', tiers: [ { max: 49.9, doseType: 'calculated', formula: "w * 15", maxDose: 750, frequency: "every 6 hours" }, { min: 50, dose: "1g", frequency: "every 6 hours" } ] }
                ]
            },
            {
                name: "Phenoxymethylpenicillin (Pen V)",
                conditions: ["Tonsillitis"],
                routes: [ { name: "Oral (PO)", bnfcLink: "https://bnfc.nice.org.uk/drugs/phenoxymethylpenicillin/", guidelines: "1m–6y: 125mg QDS | 6–12y: 250mg QDS | >12y: 500mg QDS.", doseType: 'ageBand', frequency: "four times daily", tiers: [ { min: 1, max: 71, dose: "125mg" }, { min: 72, max: 143, dose: "250mg" }, { min: 144, dose: "500mg" } ] } ]
            },
            {
                name: "Prednisolone",
                conditions: ["Acute Asthma", "Wheeze"],
                routes: [ { name: "Oral (PO) for Asthma", bnfcLink: "https://bnfc.nice.org.uk/drugs/prednisolone/", guidelines: "1m–2y: 10mg OD. | 2–5y: 20mg OD. | >5y: 30–40mg OD.", doseType: 'ageBand', frequency: "once daily for 3-5 days", tiers: [ { min: 1, max: 23, dose: "10mg" }, { min: 24, max: 59, dose: "20mg" }, { min: 60, dose: "30-40mg" } ] } ]
            },
            {
                name: "Salbutamol",
                conditions: ["Asthma", "Wheeze"],
                routes: [
                    { name: "MDI + Spacer", bnfcLink: "https://bnfc.nice.org.uk/drugs/salbutamol/", guidelines: "1 month–18 years: 2-10 puffs via spacer, repeat as needed.", minAgeMonths: 1, doseType: 'fixedText', dose: "2-10 puffs", frequency: "repeat as clinically required" },
                    { name: "Nebuliser", bnfcLink: "https://bnfc.nice.org.uk/drugs/salbutamol/", guidelines: "1m–5y: 2.5mg. | >5y: 5mg.", doseType: 'ageBand', frequency: "nebulised", tiers: [ { min: 1, max: 59, dose: "2.5mg" }, { min: 60, dose: "5mg" } ] }
                ]
            },
            {
                name: "Trimethoprim",
                conditions: ["Urinary Tract Infection (UTI)"],
                routes: [ { name: "Oral (PO) for Lower UTI", bnfcLink: "https://bnfc.nice.org.uk/drugs/trimethoprim/", guidelines: "Lower UTI (>3 months): 4mg/kg (max 200mg) twice daily for 3 days.", minAgeMonths: 3, doseType: 'calculated', formula: "w * 4", maxDose: 200, frequency: "twice daily for 3 days" } ]
            }
        ];
        const defaultObservationsData = [
            { label: "Newborn (0-1m)", min: 0, max: 1, hr: "110-160", rr: "30-50", bp: "60-90/30-60" },
            { label: "Infant (1-12m)", min: 1, max: 12, hr: "100-160", rr: "30-40", bp: "70-100/35-65" },
            { label: "Toddler (1-2y)", min: 13, max: 24, hr: "90-150", rr: "25-35", bp: "80-110/40-70" },
            { label: "Preschool (2-5y)", min: 25, max: 60, hr: "80-140", rr: "20-30", bp: "80-115/45-80" },
            { label: "School Age (5-12y)", min: 61, max: 144, hr: "70-120", rr: "15-25", bp: "90-120/50-80" },
            { label: "Adolescent (12-18y)", min: 145, max: 216, hr: "60-100", rr: "12-20", bp: "100-130/60-85" }
        ];

        let appData = [];
        let currentDrug = null;
        let ageSyncSource = null;
        let observationsData = [];

        const el = (id) => document.getElementById(id);
        const mainView = el('main-view'), calculatorView = el('calculator-view'), searchBox = el('search-box');
        const resultsList = el('results-list'), backBtn = el('back-to-search-btn'), calculatorTitle = el('calculator-title');
        const weightInput = el('weight-input'), ageYearsInput = el('age-years-input'), ageMonthsInput = el('age-months-input');
        const clearInputsBtn = el('clear-inputs-btn'), doseResultsContainer = el('dose-results-container');
        const settingsModal = el('settings-modal'), openSettingsBtn = el('open-settings-btn'), closeSettingsBtn = el('close-settings-btn');
        const saveDataBtn = el('save-data-btn'), resetDataBtn = el('reset-data-btn'), jsonEditor = el('json-editor');
        const obsRef = document.getElementById('observations-ref');

        const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; };
        const formatNumber = (num) => Math.round(num * 10) / 10;

        function calculateDose(route, w, a) {
            const safeEval = (formula) => new Function('w', 'a', `return ${formula}`)(w, a);
            const getTier = (tiers, key) => tiers.find(t => (t.min === undefined || key >= t.min) && (t.max === undefined || key <= t.max));

            if (route.minAgeMonths && a < route.minAgeMonths) return { displayValue: 'Too Young', reason: `Min age for this route is ${route.minAgeMonths} months.` };
            
            let result = { displayValue: '---', reason: 'Enter weight and age.', isCapped: false };
            let finalDose = null, isCapped = false;
            let unit = route.unit ?? 'mg';

            const processDose = (dose, freq, max, reasonPrefix = "Based on") => {
                let displayDose = dose;
                if (typeof dose === 'number') {
                    if (max && dose > max) {
                        displayDose = max;
                        isCapped = true;
                        result.reason = `Calculated dose (${formatNumber(dose)}${unit}) exceeds max dose of ${max}${unit}.`;
                    } else {
                        result.reason = `${reasonPrefix} age ${a}m, weight ${w}kg.`;
                    }
                    finalDose = `${formatNumber(displayDose)}${unit} ${freq}`;
                } else {
                    finalDose = `${dose} ${freq}`;
                    result.reason = `${reasonPrefix} age ${a}m, weight ${w}kg.`;
                }
                result.displayValue = finalDose;
                result.isCapped = isCapped;
            };

            switch (route.doseType) {
                case 'calculated':
                    processDose(safeEval(route.formula), route.frequency, route.maxDose);
                    break;
                case 'range':
                    const low = safeEval(route.formula[0]);
                    const high = safeEval(route.formula[1]);
                    if (route.maxDose && high > route.maxDose) isCapped = true;
                    const displayHigh = route.maxDose ? Math.min(high, route.maxDose) : high;
                    const rangeStr = `${formatNumber(low)}-${formatNumber(displayHigh)}${unit}`;
                    processDose(rangeStr, route.frequency, null, "Range based on");
                    if (isCapped) result.reason = `Upper range (${formatNumber(high)}${unit}) capped by max dose of ${route.maxDose}${unit}.`;
                    break;
                case 'fixedText':
                    processDose(route.dose, route.frequency, null, "Fixed dose for");
                    break;
                case 'ageBand':
                case 'weightBand':
                    const key = route.doseType === 'ageBand' ? a : w;
                    const tier = getTier(route.tiers, key);
                    if (tier) {
                        if (tier.doseType === 'calculated') { // Handle nested calculated types (like Paracetamol)
                           processDose(safeEval(tier.formula), tier.frequency, tier.maxDose);
                        } else {
                           processDose(tier.dose, tier.frequency || route.frequency, null, "Fixed dose for");
                        }
                    } else { result = { displayValue: 'Out of Range' }; }
                    break;
                default: result.reason = 'Unknown dose type.';
            }
            return result;
        }

        const renderDoseCards = debounce(() => {
            if (!currentDrug) return;
            doseResultsContainer.innerHTML = '';
            const weight = parseFloat(weightInput.value);
            const ageYears = parseInt(ageYearsInput.value) || 0;
            const ageMonths = parseInt(ageMonthsInput.value) || 0;
            const totalMonths = (ageYears * 12) + ageMonths;

            if (isNaN(weight) || weight <= 0 || totalMonths < 0) {
                doseResultsContainer.innerHTML = `<p class="no-results">Please enter a valid weight and age.</p>`;
                return;
            }

            currentDrug.routes.forEach(route => {
                const card = document.createElement('div');
                card.className = 'dose-result-card';
                const { displayValue, reason, isCapped } = calculateDose(route, weight, totalMonths);
                
                card.innerHTML = `
                    <h4>${route.name}</h4>
                    <div class="dose-output">
                        <div class="calculated-dose">
                            <div class="label">Calculated Dose</div>
                            <div class="value ${isCapped ? 'is-capped' : ''}">${displayValue}</div>
                        </div>
                        <button class="copy-btn" aria-label="Copy dose" title="Copy Dose">Copy</button>
                    </div>
                    <p class="dose-reason">${reason || ''}</p>
                    <h5>BNFc Reference Guideline:</h5>
                    <pre class="bnfc-ref">${route.guidelines}</pre>
                    <a href="${route.bnfcLink}" target="_blank" rel="noopener noreferrer" class="bnfc-link">Open BNFc Link &rarr;</a>`;
                
                const copyButton = card.querySelector('.copy-btn');
                copyButton.addEventListener('click', () => {
                    navigator.clipboard.writeText(displayValue).then(() => {
                        copyButton.textContent = 'Copied!';
                        setTimeout(() => { copyButton.textContent = 'Copy'; }, 1500);
                    });
                });
                doseResultsContainer.appendChild(card);
            });
        }, 300);

        function syncAgeInputs(source) {
            ageSyncSource = source;
            const years = parseInt(ageYearsInput.value) || 0;
            const months = parseInt(ageMonthsInput.value) || 0;
            if (source === 'months' && months >= 12) {
                ageYearsInput.value = Math.floor(months / 12);
                ageMonthsInput.value = months % 12;
            } else if (source === 'years') {
                // No action needed if years are the source, months are additive
            }
            ageSyncSource = null;
            renderDoseCards();
        }

        function loadData() {
            try {
                const storedData = localStorage.getItem('paedsDrugData');
                appData = storedData ? JSON.parse(storedData) : defaultDrugData;
                appData.sort((a, b) => a.name.localeCompare(b.name));
            } catch (e) {
                localStorage.removeItem('paedsDrugData');
                appData = defaultDrugData;
                showError('Drug data was corrupted and has been reset to defaults.');
            }
        }

        function renderResults(query = '') {
            resultsList.innerHTML = '';
            const lowerCaseQuery = query.toLowerCase();
            const filteredData = appData.filter(drug => 
                drug.name.toLowerCase().includes(lowerCaseQuery) ||
                drug.conditions.some(condition => condition.toLowerCase().includes(lowerCaseQuery))
            );
            const dataToRender = query ? filteredData : appData;
            if (dataToRender.length === 0) {
                resultsList.innerHTML = `<div class="no-results"><h3>No results found</h3><p>Try a different drug or condition name.</p></div>`;
                return;
            }
            dataToRender.forEach(drug => {
                const card = document.createElement('div');
                card.className = 'drug-card';
                card.dataset.drugName = drug.name;
                card.innerHTML = `<h3>${drug.name}</h3><p>${drug.conditions.join(', ')}</p>`;
                card.addEventListener('click', () => showCalculator(drug.name));
                resultsList.appendChild(card);
            });
        }

        function showCalculator(drugName) {
            currentDrug = appData.find(d => d.name === drugName);
            if (!currentDrug) return;
            mainView.classList.add('hidden');
            calculatorView.classList.remove('hidden');
            calculatorView.style.display = 'block';
            calculatorTitle.textContent = currentDrug.name;
            weightInput.value = '';
            ageYearsInput.value = '';
            ageMonthsInput.value = '';
            doseResultsContainer.innerHTML = `<p class="no-results">Enter weight and age to calculate dose.</p>`;
            weightInput.focus();
        }
        
        const showMainView = () => { calculatorView.style.display = 'none'; mainView.classList.remove('hidden'); searchBox.focus(); };
        const openSettings = () => { jsonEditor.value = JSON.stringify(appData, null, 2); settingsModal.style.display = 'flex'; };
        const closeSettings = () => { settingsModal.style.display = 'none'; };
        const saveData = () => { try { appData = JSON.parse(jsonEditor.value); localStorage.setItem('paedsDrugData', JSON.stringify(appData)); loadData(); renderResults(searchBox.value); closeSettings(); } catch (e) { alert('Error: Invalid JSON format. Changes not saved.'); }};
        const resetData = () => { if (confirm('Are you sure you want to reset all dosages to defaults?')) { localStorage.removeItem('paedsDrugData'); loadData(); renderResults(searchBox.value); closeSettings(); }};
        const clearInputs = () => { weightInput.value = ''; ageYearsInput.value = ''; ageMonthsInput.value = ''; renderDoseCards(); weightInput.focus(); };

        function loadObservationsData() {
            try {
                const storedObs = localStorage.getItem('paedsObsData');
                observationsData = storedObs ? JSON.parse(storedObs) : defaultObservationsData;
            } catch (e) {
                localStorage.removeItem('paedsObsData');
                observationsData = defaultObservationsData;
                showError('Observations data was corrupted and has been reset to defaults.');
            }
        }
        function saveObservationsData(newData) {
            observationsData = newData;
            localStorage.setItem('paedsObsData', JSON.stringify(observationsData));
        }
        function getObsForAge(totalMonths) {
            return observationsData.find(band => totalMonths >= band.min && totalMonths <= band.max) || null;
        }
        function renderObsRef() {
            obsRef.innerHTML = `
                <div class="obs-age-row">
                    <div class="obs-age-group">
                        <label for="obs-age-years">Age (years)</label>
                        <input type="number" id="obs-age-years" min="0" inputmode="numeric" autocomplete="off" placeholder="0">
                    </div>
                    <div class="obs-age-group">
                        <label for="obs-age-months">Months</label>
                        <input type="number" id="obs-age-months" min="0" max="11" inputmode="numeric" autocomplete="off" placeholder="0">
                    </div>
                    <button class="obs-edit-btn" id="open-obs-settings-btn" title="Edit Observations" aria-label="Edit Observations">Edit</button>
                </div>
                <div id="obs-values"></div>
            `;
            const obsAgeYears = document.getElementById('obs-age-years');
            const obsAgeMonths = document.getElementById('obs-age-months');
            const obsValues = document.getElementById('obs-values');
            function updateObsDisplay() {
                const years = parseInt(obsAgeYears.value) || 0;
                const months = parseInt(obsAgeMonths.value) || 0;
                const totalMonths = (years * 12) + months;
                const obs = getObsForAge(totalMonths);
                if (obs) {
                    obsValues.innerHTML = `
                        <div class="obs-values-card">
                            <span class="obs-value-label">HR:</span> <span class="obs-value-main">${obs.hr}</span>
                            <span class="obs-value-label">RR:</span> <span class="obs-value-main">${obs.rr}</span>
                            <span class="obs-value-label">BP:</span> <span class="obs-value-main">${obs.bp}</span>
                            <span class="obs-band-label">${obs.label}</span>
                        </div>
                    `;
                } else {
                    obsValues.innerHTML = `<div class="obs-values-card"><span style="color: var(--danger-color);">No reference for this age.</span></div>`;
                }
            }
            obsAgeYears.addEventListener('input', updateObsDisplay);
            obsAgeMonths.addEventListener('input', updateObsDisplay);
            updateObsDisplay();
            document.getElementById('open-obs-settings-btn').addEventListener('click', openObsSettings);
        }
        function openObsSettings() {
            jsonEditor.value = JSON.stringify(observationsData, null, 2);
            settingsModal.style.display = 'flex';
            // Mark that we're editing obs, not drugs
            jsonEditor.setAttribute('data-editing', 'obs');
        }
        // --- Patch settings modal to handle obs data ---
        const origOpenSettings = openSettings;
        openSettingsBtn.addEventListener('click', () => {
            jsonEditor.setAttribute('data-editing', 'drugs');
            origOpenSettings();
        });
        saveDataBtn.addEventListener('click', () => {
            if (jsonEditor.getAttribute('data-editing') === 'obs') {
                try {
                    const newObs = JSON.parse(jsonEditor.value);
                    saveObservationsData(newObs);
                    loadObservationsData();
                    renderObsRef();
                    closeSettings();
                } catch (e) { alert('Error: Invalid JSON format. Changes not saved.'); }
            } else {
                saveData();
            }
        });
        resetDataBtn.addEventListener('click', () => {
            if (jsonEditor.getAttribute('data-editing') === 'obs') {
                if (confirm('Reset observations to defaults?')) {
                    localStorage.removeItem('paedsObsData');
                    loadObservationsData();
                    renderObsRef();
                    closeSettings();
                }
            } else {
                resetData();
            }
        });
        // --- End patch ---

        searchBox.addEventListener('input', () => renderResults(searchBox.value));
        backBtn.addEventListener('click', showMainView);
        weightInput.addEventListener('input', renderDoseCards);
        ageYearsInput.addEventListener('input', () => { if (!ageSyncSource) syncAgeInputs('years'); });
        ageMonthsInput.addEventListener('input', () => { if (!ageSyncSource) syncAgeInputs('months'); });
        clearInputsBtn.addEventListener('click', clearInputs);
        openSettingsBtn.addEventListener('click', openSettings);
        closeSettingsBtn.addEventListener('click', closeSettings);
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettings(); });
        
        function safeRenderResults(query = '') {
            if (!resultsList) { showError('Results container missing.'); return; }
            renderResults(query);
        }
        function safeRenderObsRef() {
            if (!obsRef) { showError('Observations container missing.'); return; }
            renderObsRef();
        }
        
        try {
            loadData();
            safeRenderResults();
            loadObservationsData();
            safeRenderObsRef();
        } catch (e) {
            showError('A critical error occurred: ' + (e.message || e));
        }
    });
    </script>
</body>
</html>
